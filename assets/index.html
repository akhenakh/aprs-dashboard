<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}
    </style>
    <script type="text/javascript" src="/jquery-2.1.1.js"></script>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?sensor=false">
    </script>
    <script type="text/javascript">

function initialize() {
    var mapOptions = {
        center: { lat: -34.397, lng: 150.644},
        zoom: 8
    };
    var map = new google.maps.Map(document.getElementById('map-canvas'),
				  mapOptions);
    
    // Try HTML5 Geolocation
    var defaultPos = new google.maps.LatLng(-34.397, 150.644);

    if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude)
            map.setCenter(pos);
	    centerMap(map, pos);
        }, function() {
            map.setCenter(defaultPos);
	    centerMap(map, defaultPos);
        });
    } else {
        map.setCenter(defaultPos);
        centerMap(map, defaultPos);
    }

    google.maps.event.addListener(map, 'center_changed', function(event) {
        centerMap(map, map.getCenter());
    });
}

function centerMap(map, pos) {
    $.ajax({
        type: "GET",
        url: "/api/v1/position?lat=" + pos.lat() + "&long=" + pos.lng() + "&radius=200&time=3600",  
        dataType: "json",  
        success: function(resp){
            handleSearchResponse(map, resp);
        },  
        error: function(e){  
            alert('Error retrieving callsigns: ' + e);  
        }  
    });
}

function handleSearchResponse(map, resp) {
    var arrayLength = resp.records.length;
    for (var i = 0; i < arrayLength; i++) {
	var entry = resp.records[i];
	var myLatLng = new google.maps.LatLng(entry.latitude, entry.longitude);
	var marker = new google.maps.Marker({
	    position: myLatLng,
	    map: map,
	    title: entry.src_callsign
	});
    }
}

google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
<div id="map-canvas"></div>
  </body>
</html>
